name: EduConnect Autopilot

on:
  push:
    paths:
      - "**/*"
      - ".github/workflows/**"
      - "!**/*.md"
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

concurrency:
  group: educonnect-autopilot
  cancel-in-progress: false

jobs:
  autopilot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare log
        run: echo "EduConnect Autopilot start $(date -Is)" > ci.log

      # Probe whether this repo is a Node project
      - name: Probe Node workspace
        id: probe
        shell: bash
        run: |
          if [ -f package.json ]; then
            echo "has_node=1" >> $GITHUB_OUTPUT
            echo "Found package.json" | tee -a ci.log
          else
            echo "has_node=0" >> $GITHUB_OUTPUT
            echo "No package.json at repo root; skipping Node steps." | tee -a ci.log
          fi

      - name: Setup Node (only if Node project)
        if: steps.probe.outputs.has_node == '1'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps (robust)
        if: steps.probe.outputs.has_node == '1'
        id: install
        shell: bash
        run: |
          set -o pipefail
          (npm ci --omit=optional --no-audit --no-fund || npm i --legacy-peer-deps --omit=optional --no-audit --no-fund) 2>&1 | tee -a ci.log
          echo "rc=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      # Heal ESLint CLI flags if present in scripts
      - name: Heal ESLint flags
        if: steps.probe.outputs.has_node == '1'
        id: heal_eslint
        shell: bash
        run: |
          set -e
          patched=0
          if [ -f package.json ] && grep -q -- "--ext ts,tsx" package.json; then
            node -e "let fs=require('fs'),j=JSON.parse(fs.readFileSync('package.json','utf8')); if(j.scripts){ for(const k of ['lint','lint:fix']) if(j.scripts[k]) j.scripts[k]=j.scripts[k].replace('--ext ts,tsx',''); } fs.writeFileSync('package.json', JSON.stringify(j,null,2));"
            git config user.name  "jarvis-bot"
            git config user.email "ops.aogrl.autopilot@gmail.com"
            git add package.json && git commit -m "chore(ci): drop --ext for flat ESLint" || true
            git push || true
            patched=1
          fi
          echo "patched=$patched" >> $GITHUB_OUTPUT

      - name: Lint & fix (best-effort)
        if: steps.probe.outputs.has_node == '1'
        id: lint
        shell: bash
        run: |
          set -o pipefail
          rc=0
          if jq -e '.scripts["lint:fix"]' package.json >/dev/null 2>&1; then
            (npm run lint:fix || true) 2>&1 | tee -a ci.log || true
          fi
          if jq -e '.scripts["lint"]' package.json >/dev/null 2>&1; then
            (npm run lint || true) 2>&1 | tee -a ci.log || true
          fi
          echo "rc=$rc" >> $GITHUB_OUTPUT

      - name: Commit changes if any
        if: steps.probe.outputs.has_node == '1'
        id: commit
        shell: bash
        run: |
          set -e
          git config user.name  "jarvis-bot"
          git config user.email "ops.aogrl.autopilot@gmail.com"
          if ! git diff --quiet; then
            (git add -A && git commit -m "chore(ci): auto-fix lint" && git push) 2>&1 | tee -a ci.log
            echo "rc=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit." | tee -a ci.log
            echo "rc=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload CI log
        uses: actions/upload-artifact@v4
        with:
          name: ci-log
          path: ci.log
          retention-days: 7
          if-no-files-found: warn

      # Only decide failure if we actually ran Node steps
      - name: Decide result
        id: decide
        shell: bash
        run: |
          if [ "${{ steps.probe.outputs.has_node }}" != "1" ]; then
            echo "fail=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          fail=0
          [ "${{ steps.install.outputs.rc }}" != "0" ] && fail=1
          [ "${{ steps.lint.outputs.rc }}"    != "0" ] && fail=1
          [ "${{ steps.commit.outputs.rc }}"  != "0" ] && fail=1
          echo "fail=$fail" >> $GITHUB_OUTPUT

      - name: Create failure issue (with log tail)
        if: steps.decide.outputs.fail == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const log = fs.existsSync('ci.log') ? fs.readFileSync('ci.log','utf8') : 'no log';
            const tail = log.slice(-6000);
            const title = `CI failed: ${context.workflow} @ ${context.sha.slice(0,7)}`;
            const body  = `Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n---\n\`\`\`\n${tail}\n\`\`\``;
            await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title, body, labels: ['ci-failure'] });

      - name: Mark job failed if any step failed
        if: steps.decide.outputs.fail == '1'
        run: exit 1
