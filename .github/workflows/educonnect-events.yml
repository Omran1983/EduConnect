name: EduConnect Events to Supabase

on:
  push:
    branches: ["main", "master"]
  pull_request:
    types: [opened, synchronize, reopened, closed]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  log:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Build JSON payload
        env:
          KIND:   ${{ github.event_name }}
          REPO:   ${{ github.repository }}
          ACTOR:  ${{ github.actor }}
          SERVER: ${{ github.server_url }}
          RUN_ID: ${{ github.run_id }}
          SHA:    ${{ github.sha }}
          REF:    ${{ github.ref }}

          COMMIT_MSG:  ${{ github.event.head_commit.message || '' }}
          PR_TITLE:    ${{ github.event.pull_request.title || '' }}
          PR_ACTION:   ${{ github.event.action || '' }}
          PR_MERGED:   ${{ github.event.pull_request.merged || false }}
          REL_TAG:     ${{ github.event.release.tag_name || '' }}
          REL_URL:     ${{ github.event.release.html_url || '' }}
        run: |
          set -e
          SHORT_SHA="${SHA:0:7}"
          RUN_URL="$SERVER/$REPO/actions/runs/$RUN_ID"

          case "$KIND" in
            push)
              BRANCH="${REF#refs/heads/}"
              TITLE="PUSH $SHORT_SHA @ $REPO:$BRANCH"
              META=$(jq -n --arg actor "$ACTOR" --arg msg "$COMMIT_MSG" --arg run "$RUN_URL" --arg sha "$SHA" \
                        '{actor:$actor,message:$msg,run_url:$run,sha:$sha}')
              ;;
            pull_request)
              TITLE="PR ($PR_ACTION): $PR_TITLE"
              META=$(jq -n --arg actor "$ACTOR" --arg action "$PR_ACTION" --arg run "$RUN_URL" --argjson merged "$PR_MERGED" \
                        '{actor:$actor,action:$action,merged:$merged,run_url:$run}')
              ;;
            release)
              TITLE="RELEASE $REL_TAG"
              META=$(jq -n --arg actor "$ACTOR" --arg url "$REL_URL" --arg run "$RUN_URL" \
                        '{actor:$actor,url:$url,run_url:$run}')
              ;;
            *)
              TITLE="Event $KIND @ $REPO"
              META=$(jq -n --arg actor "$ACTOR" --arg run "$RUN_URL" \
                        '{actor:$actor,run_url:$run}')
              ;;
          esac

          jq -n --arg source "github" --arg kind "$KIND" --arg title "$TITLE" --argjson meta "$META" \
                '{source:$source,kind:$kind,title:$title,meta:$meta}' > payload.json

          echo "Payload:"
          jq . payload.json

      - name: Insert into Supabase
        env:
          SUPABASE_URL:          ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        run: |
          set -e
          test -n "$SUPABASE_URL" && test -n "$SUPABASE_SERVICE_ROLE"
          curl -sS -f -X POST "$SUPABASE_URL/rest/v1/project_events" \
            -H "apikey: $SUPABASE_SERVICE_ROLE" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json
